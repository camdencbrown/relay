<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relay — Agent-First Data Movement</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}

        :root{
            --bg:#08090c;
            --surface:#0e1014;
            --surface-hover:#14161c;
            --border:#1c1e26;
            --border-light:#2a2c36;
            --accent:#c8a46e;
            --accent-dim:rgba(200,164,110,.15);
            --accent-glow:rgba(200,164,110,.06);
            --text:#e8e4dd;
            --text-dim:#8a8690;
            --text-faint:#55525c;
            --success:#6ecf8e;
            --danger:#cf6e6e;
            --warning:#cfb86e;
            --serif:'DM Serif Display',Georgia,serif;
            --sans:'Outfit',system-ui,sans-serif;
        }

        body{
            font-family:var(--sans);
            background:var(--bg);
            color:var(--text);
            overflow-x:hidden;
            min-height:100vh;
        }

        /* Grain overlay */
        body::before{
            content:'';
            position:fixed;
            inset:0;
            background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events:none;
            z-index:9999;
        }

        /* Ambient gradients */
        .ambient{
            position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;
        }
        .ambient .orb{
            position:absolute;
            border-radius:50%;
            filter:blur(120px);
            opacity:.07;
            animation:drift 20s ease-in-out infinite alternate;
        }
        .ambient .orb:nth-child(1){width:600px;height:600px;background:var(--accent);top:-200px;right:-100px;animation-delay:0s}
        .ambient .orb:nth-child(2){width:500px;height:500px;background:#6e8dcf;bottom:-150px;left:-100px;animation-delay:-7s}
        .ambient .orb:nth-child(3){width:400px;height:400px;background:var(--accent);top:50%;left:50%;animation-delay:-14s}

        @keyframes drift{
            0%{transform:translate(0,0) scale(1)}
            100%{transform:translate(60px,40px) scale(1.1)}
        }

        /* Layout */
        .container{
            position:relative;z-index:1;
            max-width:1200px;
            margin:0 auto;
            padding:60px 40px;
        }

        /* Header */
        .brand{
            display:flex;align-items:center;gap:16px;
            margin-bottom:12px;
        }
        .brand-mark{
            width:36px;height:36px;
            border:1.5px solid var(--accent);
            border-radius:8px;
            display:grid;place-items:center;
            color:var(--accent);
            font-size:16px;
        }
        .brand h1{
            font-family:var(--serif);
            font-size:1.8rem;
            font-weight:400;
            color:var(--text);
            letter-spacing:1px;
        }
        .brand h1 span{color:var(--accent)}

        .subtitle{
            font-size:.95rem;
            color:var(--text-dim);
            font-weight:300;
            margin-bottom:48px;
            letter-spacing:.3px;
        }

        /* Stats row */
        .stats{
            display:grid;
            grid-template-columns:repeat(4,1fr);
            gap:16px;
            margin-bottom:48px;
        }
        .stat{
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:12px;
            padding:24px;
            transition:border-color .3s;
        }
        .stat:hover{border-color:var(--border-light)}
        .stat-label{
            font-size:.7rem;
            text-transform:uppercase;
            letter-spacing:1.5px;
            color:var(--text-faint);
            margin-bottom:10px;
        }
        .stat-value{
            font-family:var(--serif);
            font-size:2rem;
            color:var(--accent);
        }

        /* Section */
        .section-title{
            font-family:var(--serif);
            font-size:1.3rem;
            font-weight:400;
            color:var(--text);
            margin-bottom:24px;
            display:flex;align-items:center;gap:12px;
        }
        .section-title::after{
            content:'';flex:1;height:1px;background:var(--border);
        }

        /* Pipeline cards */
        .pipeline{
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:14px;
            padding:28px;
            margin-bottom:16px;
            transition:all .3s;
        }
        .pipeline:hover{
            border-color:var(--accent);
            box-shadow:0 0 40px var(--accent-glow);
            transform:translateY(-1px);
        }
        .pipeline-top{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:20px;
        }
        .pipeline-name{
            font-family:var(--serif);
            font-size:1.2rem;
            color:var(--text);
        }
        .badge{
            padding:4px 14px;
            border-radius:20px;
            font-size:.7rem;
            font-weight:600;
            letter-spacing:.8px;
            text-transform:uppercase;
        }
        .badge-active{background:rgba(110,207,142,.12);color:var(--success)}
        .badge-failed{background:rgba(207,110,110,.12);color:var(--danger)}
        .badge-running{background:rgba(200,164,110,.12);color:var(--accent)}

        /* Flow visualization */
        .flow{
            display:flex;align-items:center;gap:0;
        }
        .flow-node{
            flex:1;
            background:rgba(255,255,255,.02);
            border:1px solid var(--border);
            border-radius:10px;
            padding:16px;
            text-align:center;
        }
        .flow-node-label{
            font-size:.6rem;
            text-transform:uppercase;
            letter-spacing:1.5px;
            color:var(--text-faint);
            margin-bottom:6px;
        }
        .flow-node-value{
            font-size:.85rem;
            font-weight:500;
            color:var(--text);
        }
        .flow-arrow{
            color:var(--accent);
            font-size:.8rem;
            padding:0 8px;
            opacity:.5;
        }

        /* Pipeline meta row */
        .pipeline-meta{
            display:flex;gap:24px;
            margin-top:16px;
            padding-top:16px;
            border-top:1px solid var(--border);
        }
        .pipeline-meta-item{
            font-size:.75rem;
            color:var(--text-dim);
        }
        .pipeline-meta-item strong{
            color:var(--text);
            font-weight:500;
        }

        /* Actions */
        .pipeline-actions{
            display:flex;gap:8px;
        }
        .btn{
            padding:7px 16px;
            border-radius:8px;
            border:1px solid var(--border);
            background:transparent;
            color:var(--text-dim);
            font-family:var(--sans);
            font-size:.75rem;
            font-weight:500;
            cursor:pointer;
            transition:all .2s;
            letter-spacing:.3px;
        }
        .btn:hover{
            border-color:var(--accent);
            color:var(--accent);
        }
        .btn-accent{
            background:var(--accent-dim);
            border-color:var(--accent);
            color:var(--accent);
        }
        .btn-accent:hover{
            background:var(--accent);
            color:var(--bg);
        }
        .btn-danger{
            border-color:rgba(207,110,110,.3);
            color:var(--danger);
        }
        .btn-danger:hover{
            background:rgba(207,110,110,.1);
        }

        /* Empty state */
        .empty{
            text-align:center;
            padding:80px 20px;
        }
        .empty-icon{
            width:64px;height:64px;
            border:1.5px solid var(--border);
            border-radius:16px;
            display:inline-grid;place-items:center;
            color:var(--text-faint);
            font-size:24px;
            margin-bottom:24px;
        }
        .empty h3{
            font-family:var(--serif);
            font-size:1.2rem;
            font-weight:400;
            color:var(--text-dim);
            margin-bottom:8px;
        }
        .empty p{
            color:var(--text-faint);
            font-size:.85rem;
            margin-bottom:24px;
        }

        /* Footer */
        .footer{
            margin-top:60px;
            padding-top:24px;
            border-top:1px solid var(--border);
            display:flex;
            justify-content:space-between;
            align-items:center;
            color:var(--text-faint);
            font-size:.75rem;
        }
        .footer a{
            color:var(--accent);
            text-decoration:none;
            transition:opacity .2s;
        }
        .footer a:hover{opacity:.7}

        /* Modal */
        .modal-overlay{
            display:none;
            position:fixed;inset:0;
            background:rgba(8,9,12,.85);
            backdrop-filter:blur(8px);
            z-index:1000;
            place-items:center;
        }
        .modal{
            background:var(--surface);
            border:1px solid var(--border);
            border-radius:16px;
            padding:36px;
            max-width:800px;width:90%;
            max-height:80vh;overflow-y:auto;
        }
        .modal h2{
            font-family:var(--serif);
            font-size:1.4rem;
            font-weight:400;
            margin-bottom:20px;
        }
        .modal-close{
            float:right;
            background:none;border:none;
            color:var(--text-faint);
            font-size:24px;cursor:pointer;
        }
        .modal pre{
            font-family:'SF Mono','Fira Code',monospace;
            font-size:.8rem;
            line-height:1.8;
            color:var(--text-dim);
            white-space:pre-wrap;
        }

        @media(max-width:768px){
            .container{padding:30px 20px}
            .stats{grid-template-columns:repeat(2,1fr)}
            .flow{flex-direction:column}
            .flow-arrow{transform:rotate(90deg)}
        }
    </style>
</head>
<body>
    <div class="ambient">
        <div class="orb"></div>
        <div class="orb"></div>
        <div class="orb"></div>
    </div>

    <div class="container">
        <div class="brand">
            <div class="brand-mark">R</div>
            <h1><span>Relay</span></h1>
        </div>
        <p class="subtitle">Agent-first data movement & analytics</p>

        <div class="stats">
            <div class="stat">
                <div class="stat-label">Pipelines</div>
                <div class="stat-value" id="total-pipelines">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Active</div>
                <div class="stat-value" id="active-pipelines">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Total Runs</div>
                <div class="stat-value" id="total-runs">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Rows Moved</div>
                <div class="stat-value" id="rows-processed">0</div>
            </div>
        </div>

        <div class="section-title">Pipelines</div>
        <div id="pipelines-list"></div>

        <div class="footer">
            <span>Relay v2.0 — Agent-First Data Movement</span>
            <span>
                <a href="/api/v1/capabilities">Capabilities</a> &nbsp;&middot;&nbsp;
                <a href="/docs">API Docs</a>
            </span>
        </div>
    </div>

    <div class="modal-overlay" id="detailsModal">
        <div class="modal">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2 id="modalTitle">Details</h2>
            <div id="modalContent"><pre></pre></div>
        </div>
    </div>

    <script>
    async function loadPipelines(){
        try{
            const r=await fetch('/api/v1/pipeline/list');
            const data=await r.json();

            document.getElementById('total-pipelines').textContent=data.total;
            document.getElementById('active-pipelines').textContent=data.pipelines.filter(p=>p.status==='active').length;
            document.getElementById('total-runs').textContent=data.pipelines.reduce((s,p)=>s+p.total_runs,0);

            let rows=0;
            data.pipelines.forEach(p=>{if(p.last_run&&p.last_run.rows_processed)rows+=p.last_run.rows_processed});
            document.getElementById('rows-processed').textContent=rows.toLocaleString();

            const el=document.getElementById('pipelines-list');
            if(!data.pipelines.length){
                el.innerHTML=`
                    <div class="empty">
                        <div class="empty-icon">+</div>
                        <h3>No pipelines yet</h3>
                        <p>Create your first pipeline through the API or let an agent do it.</p>
                        <a href="/docs" class="btn btn-accent">API Documentation</a>
                    </div>`;
                return;
            }

            el.innerHTML=data.pipelines.map(p=>{
                const lr=p.last_run;
                const st=lr?lr.status:'pending';
                const bc=st==='success'?'active':st==='running'?'running':'failed';
                const srcType=(p.source_type||p.type||'').toUpperCase();
                const destType=(p.destination_type||'s3').toUpperCase();
                const rowsStr=lr&&lr.rows_processed?lr.rows_processed.toLocaleString()+' rows':'—';
                const dur=lr&&lr.duration_seconds?lr.duration_seconds.toFixed(1)+'s':'—';
                const created=new Date(p.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric'});

                return `
                <div class="pipeline">
                    <div class="pipeline-top">
                        <div style="display:flex;align-items:center;gap:14px">
                            <span class="pipeline-name">${p.name}</span>
                            <span class="badge badge-${bc}">${st}</span>
                        </div>
                        <div class="pipeline-actions">
                            <button class="btn" onclick="viewDetails('${p.id}')">Details</button>
                            <button class="btn btn-accent" onclick="runPipeline('${p.id}')">Run</button>
                            <button class="btn btn-danger" onclick="deletePipeline('${p.id}','${p.name}')">Delete</button>
                        </div>
                    </div>
                    <div class="flow">
                        <div class="flow-node">
                            <div class="flow-node-label">Source</div>
                            <div class="flow-node-value">${srcType}</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-node">
                            <div class="flow-node-label">Process</div>
                            <div class="flow-node-value">Relay</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-node">
                            <div class="flow-node-label">Destination</div>
                            <div class="flow-node-value">${destType}</div>
                        </div>
                        <div class="flow-arrow">&rarr;</div>
                        <div class="flow-node">
                            <div class="flow-node-label">Query</div>
                            <div class="flow-node-value">DuckDB</div>
                        </div>
                    </div>
                    <div class="pipeline-meta">
                        <div class="pipeline-meta-item"><strong>${rowsStr}</strong> processed</div>
                        <div class="pipeline-meta-item"><strong>${dur}</strong> duration</div>
                        <div class="pipeline-meta-item"><strong>${p.total_runs}</strong> runs</div>
                        <div class="pipeline-meta-item">Created <strong>${created}</strong></div>
                    </div>
                </div>`;
            }).join('');
        }catch(e){console.error('Load failed:',e)}
    }

    function closeModal(){document.getElementById('detailsModal').style.display='none'}

    async function viewDetails(id){
        try{
            const r=await fetch(`/api/v1/pipeline/${id}`);
            const d=await r.json();
            document.getElementById('modalTitle').textContent=d.name;
            document.getElementById('modalContent').innerHTML=`<pre>${JSON.stringify(d,null,2)}</pre>`;
            document.getElementById('detailsModal').style.display='grid';
        }catch(e){
            document.getElementById('modalContent').innerHTML=`<pre>Error: ${e.message}</pre>`;
            document.getElementById('detailsModal').style.display='grid';
        }
    }

    async function runPipeline(id){
        if(!confirm('Run this pipeline?'))return;
        try{
            const r=await fetch(`/api/v1/pipeline/${id}/run`,{method:'POST'});
            const d=await r.json();
            if(d.status==='started'){
                alert(`Started! Run ID: ${d.run_id}`);
                setTimeout(loadPipelines,2000);
            }
        }catch(e){alert('Failed: '+e.message)}
    }

    async function deletePipeline(id,name){
        if(!confirm(`Delete "${name}"?`))return;
        try{
            await fetch(`/api/v1/pipeline/${id}`,{method:'DELETE'});
            loadPipelines();
        }catch(e){alert('Failed: '+e.message)}
    }

    loadPipelines();
    setInterval(loadPipelines,5000);
    </script>
</body>
</html>
